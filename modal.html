<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Modal de Contraseña</title>
  <style>
    /* Estilo básico para el modal */
    #modalpswunica {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    #modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- Botón para abrir el modal -->
<button onclick="abrirModal()">Abrir Modal</button>

<!-- Modal -->
<div id="modalpswunica">
  <div id="modal-content">
    <h2>Ingresa tu contraseña</h2>
    <input type="password" id="passwordInput" />
    <br />
    <button onclick="verificarContraseña(event)">Verificar</button>
    <button onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script>
function abrirModal() {
  document.getElementById('modalpswunica').style.display = 'flex';
  document.getElementById('passwordInput').focus()
}

function cerrarModal() {
    document.getElementById('passwordInput').value = '';
    document.getElementById('modalpswunica').style.display = 'none';
}

function verificarContraseña(event) {
   event.preventDefault();
  // Obtener el valor de la contraseña ingresada
  const pass= document.getElementById('passwordInput').value;
  desencriptaClave(event,pass)
  .then(validada => {
       if (validada) {
           alert('Clave desencriptada ok');
           const data='clara'
           const dataOk=JSON.stringify(data)
           localStorage.setItem('luz',dataOk)
           cerrarModal();
       } else {
           const data='off'
           const dataOk=JSON.stringify(data)
           localStorage.setItem('luz',dataOk)
           alert('Clave no desencriptada');
           document.getElementById('passwordInput').select()
           document.getElementById('passwordInput').focus()
       }
     })
     .catch(error => {
           const data='off'
           const dataOk=JSON.stringify(data)
           localStorage.setItem('luz',dataOk)
           console.error('Error en la validación:', error.message);
           alert('Error en la validación');
     });
}
  
// Función para desencriptar una clave a partir de un archivo
function desencriptaClave(event,claveDesencriptar) {
    event.preventDefault()
    return new Promise((resolve, reject) => {
        // Crear dinámicamente un elemento de entrada de tipo file
        const input = document.createElement('input');
        input.type = 'file';
        input.style.display = 'none';
        // Manejar el evento de cambio en el elemento de entrada de tipo file
        input.addEventListener('change', function() {
            // Obtener el archivo seleccionado
            const archivo = input.files[0];
            // Leer el contenido del archivo seleccionado como Blob
            const reader = new FileReader();
            reader.onload = function() {
                const claveEncriptada = reader.result;
                // Desencriptar la clave
                try {
                    const bytesDesencriptados = CryptoJS.AES.decrypt(claveEncriptada, claveDesencriptar);
                    const claveDesencriptada = bytesDesencriptados.toString(CryptoJS.enc.Utf8);
                    if (claveDesencriptada !== '') {
                        if(claveDesencriptada===claveDesencriptar){
                            resolve(true); // Resuelve la promesa con éxito
                        } else {
                            resolve(false)
                        }
                    } else {
                        resolve(false); // Resuelve la promesa indicando que no fue válida
                    }
                } catch (error) {
                    reject(error); // Rechaza la promesa en caso de error
                } finally {
                    // Eliminar el elemento de entrada de tipo file después de la ejecución
                    document.body.removeChild(input);
                }
            };
            reader.readAsText(archivo);
        });
        // Agregar el elemento de entrada de tipo file al cuerpo del documento
        document.body.appendChild(input);
        // Abrir el cuadro de diálogo para seleccionar archivos
        input.click();
    });
}

</script>
<script src="./crypto-js.js"></script>

</body>
</html>
